name: CVE Automation with Filtering

on:
  # Run every 6 hours (at 0, 6, 12, 18 UTC)
  schedule:
    - cron: '0 0,6,12,18 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      cvss_threshold:
        description: 'Minimum CVSS score threshold'
        required: false
        default: '8.0'

jobs:
  cve-automation-with-filter:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Node.js dependencies
        run: npm install
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Search for CVEs
        id: search
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          CVSS_THRESHOLD: ${{ github.event.inputs.cvss_threshold || '8.0' }}
        run: |
          echo "Searching for CVEs with threshold: $CVSS_THRESHOLD"
          node src/cve-search.js > /tmp/cves-raw.json || {
            echo "CVE search failed, creating empty result"
            echo "[]" > /tmp/cves-raw.json
          }
          
          # Check if we have results
          CVE_COUNT=$(jq length /tmp/cves-raw.json)
          echo "found_cves=$CVE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $CVE_COUNT CVEs"
        continue-on-error: true
      
      - name: Filter advisories using keyword matching
        id: filter
        if: steps.search.outputs.found_cves > 0
        run: |
          echo "Filtering advisories..."
          
          # Run the filter script
          python scripts/filter_advisories.py \
            .github/workflows/filter-config.yml \
            /tmp/cves-raw.json > /tmp/filtered-results.json || {
            echo "Filtering failed, using unfiltered results"
            # Create a simple wrapper for unfiltered results
            jq '{total_advisories: length, filtered_advisories: length, results: [.[] | {advisory: ., matches: {matched_keywords: {}, matched_categories: [], matched_patterns: []}, relevance_score: 1}], statistics: {filter_efficiency: "100%", categories_used: 0, regex_patterns_used: 0}}' \
              /tmp/cves-raw.json > /tmp/filtered-results.json
          }
          
          # Get count of filtered advisories
          FILTERED_COUNT=$(jq '.filtered_advisories' /tmp/filtered-results.json)
          echo "filtered_count=$FILTERED_COUNT" >> $GITHUB_OUTPUT
          echo "Filtered to $FILTERED_COUNT relevant advisories"
        continue-on-error: true
      
      - name: Generate advisories from filtered results
        id: generate
        if: steps.filter.outputs.filtered_count > 0
        run: |
          echo "Generating advisories from filtered results..."
          
          # Create advisories directory
          mkdir -p data/advisories
          
          # Extract advisories and save them
          jq -r '.results[] | .advisory' /tmp/filtered-results.json | \
          jq -s '.' | \
          jq -r '.[] | @json' | \
          while IFS= read -r advisory; do
            CVE_ID=$(echo "$advisory" | jq -r '.id')
            echo "$advisory" | jq '.' > "data/advisories/${CVE_ID}.json"
          done
          
          # Count generated advisories
          ADVISORY_COUNT=$(ls -1 data/advisories/*.json 2>/dev/null | wc -l)
          echo "advisory_count=$ADVISORY_COUNT" >> $GITHUB_OUTPUT
          echo "Generated $ADVISORY_COUNT advisory files"
      
      - name: Generate markdown notification
        id: notification
        if: steps.filter.outputs.filtered_count > 0
        run: |
          echo "Generating notification..."
          
          # Generate markdown notification
          python scripts/generate_notification.py \
            /tmp/filtered-results.json \
            markdown > /tmp/notification.md
          
          # Generate Teams payload
          python scripts/generate_notification.py \
            /tmp/filtered-results.json \
            teams > /tmp/teams-payload.json
          
          # Generate Slack payload  
          python scripts/generate_notification.py \
            /tmp/filtered-results.json \
            slack > /tmp/slack-payload.json
          
          echo "‚úì Notifications generated"
      
      - name: Send to Microsoft Teams
        if: steps.filter.outputs.filtered_count > 0 && env.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          echo "Sending notification to Microsoft Teams..."
          
          curl -X POST "$TEAMS_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/teams-payload.json || {
            echo "‚ö†Ô∏è  Failed to send Teams notification"
          }
        continue-on-error: true
      
      - name: Send to Slack
        if: steps.filter.outputs.filtered_count > 0 && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "Sending notification to Slack..."
          
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/slack-payload.json || {
            echo "‚ö†Ô∏è  Failed to send Slack notification"
          }
        continue-on-error: true
      
      - name: Update deduplication state
        if: steps.search.outputs.found_cves > 0
        run: |
          echo "Updating deduplication state..."
          
          # Use Node.js deduplication logic
          node -e "
          const fs = require('fs');
          const { Deduplicator } = require('./src/deduplication');
          
          try {
            // Load raw CVEs
            const cves = JSON.parse(fs.readFileSync('/tmp/cves-raw.json', 'utf8'));
            
            if (cves.length > 0) {
              const deduplicator = new Deduplicator('data/state.json');
              deduplicator.markAsProcessed(cves);
              console.log('‚úì State updated');
            } else {
              console.log('No CVEs to process');
            }
          } catch (error) {
            console.error('Error updating state:', error.message);
            process.exit(1);
          }
          "
      
      - name: Generate workflow summary
        if: always()
        run: |
          echo "## üîí CVE Automation with Filtering - Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f /tmp/filtered-results.json ]; then
            echo "### üìä Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            TOTAL=$(jq -r '.total_advisories' /tmp/filtered-results.json)
            FILTERED=$(jq -r '.filtered_advisories' /tmp/filtered-results.json)
            EFFICIENCY=$(jq -r '.statistics.filter_efficiency' /tmp/filtered-results.json)
            
            echo "- **Total CVEs Scanned:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Relevant CVEs Found:** $FILTERED" >> $GITHUB_STEP_SUMMARY
            echo "- **Filter Efficiency:** $EFFICIENCY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show severity breakdown if we have results
            if [ "$FILTERED" -gt 0 ]; then
              echo "### üéØ Severity Breakdown" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              jq -r '.results[].advisory.severity' /tmp/filtered-results.json | \
              sort | uniq -c | \
              while read count severity; do
                case "$severity" in
                  CRITICAL) emoji="üî¥" ;;
                  HIGH) emoji="üü†" ;;
                  MEDIUM) emoji="üü°" ;;
                  LOW) emoji="üü¢" ;;
                  *) emoji="‚ö™" ;;
                esac
                echo "- $emoji **$severity:** $count" >> $GITHUB_STEP_SUMMARY
              done
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### üö® Top 5 Advisories" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              jq -r '.results[:5][] | "- **\(.advisory.id)** (CVSS: \(.advisory.cvssScore)) - \(.advisory.severity) - Score: \(.relevance_score)"' \
                /tmp/filtered-results.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ÑπÔ∏è No Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No CVEs were found or processed in this run." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cve-automation-results-${{ github.run_number }}
          path: |
            /tmp/cves-raw.json
            /tmp/filtered-results.json
            /tmp/notification.md
            /tmp/teams-payload.json
            /tmp/slack-payload.json
            data/advisories/*.json
            data/state.json
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Commit updated state and advisories
        if: steps.search.outputs.found_cves > 0
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Stage the data files
          git add -f data/state.json || true
          git add -f data/advisories/*.json || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected. Committing..."
            git commit -m "Update CVE state and advisories [automated with filtering]"
            
            # Stash any leftover files
            git stash || true
            
            # Pull safely (Rebase) - exit on conflict
            if ! git pull --rebase origin main; then
              echo "‚ö†Ô∏è  Merge conflict detected. Manual intervention required."
              exit 1
            fi
            
            # Push the changes
            git push || {
              echo "‚ö†Ô∏è  Push failed, changes may need manual intervention"
              exit 1
            }
          fi
