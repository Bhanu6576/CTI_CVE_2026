name: CVE Automation Workflow

on:
  # Run every 6 hours (at 0, 6, 12, 18 UTC)
  schedule:
    - cron: '0 0,6,12,18 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      cvss_threshold:
        description: 'Minimum CVSS score threshold'
        required: false
        default: '8.0'

jobs:
  cve-automation:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Standard permission is enough now!
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Search for CVEs and Notify
        id: search
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          CVSS_THRESHOLD: ${{ github.event.inputs.cvss_threshold || '8.0' }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: node src/index.js
      
      - name: Commit updated state
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 1. Stage the NEW data files
          # We use 'force' (-f) just in case .gitignore tries to block it, though it shouldn't.
          git add -f data/state.json
          git add -f data/advisories/*.json || true
          
          # 2. Check if there are actually changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected. Committing..."
            git commit -m "Update CVE state and advisories [automated]"
            
            # 3. Stash any leftover junk to clean the workspace
            git stash
            
            # 4. Pull safely (Rebase)
            git pull --rebase origin main
            
            # 5. Push the changes
            git push
          fi
